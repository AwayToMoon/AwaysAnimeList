const words = [
    {
        category: "Anime-Serien",
        items: [
            {
                word: "NARUTO",
                hint: "Ninja mit Fuchsdämon",
                difficulty: 1
            },
            {
                word: "DRAGONBALL",
                hint: "Kampf um die Drachenkugeln",
                difficulty: 1
            },
            {
                word: "ONEPIECE",
                hint: "Schatzsuche auf See",
                difficulty: 2
            },
            {
                word: "ATTACKONTITAN",
                hint: "Kampf gegen Riesen",
                difficulty: 3
            },
            {
                word: "DEATHNOTE",
                hint: "Todesnotizbuch",
                difficulty: 2
            },
            {
                word: "DEMONSLAYER",
                hint: "Kampf gegen Dämonen",
                difficulty: 2
            },
            {
                word: "MYHEROACADEMIA",
                hint: "Superhelden-Akademie",
                difficulty: 3
            },
            {
                word: "TOKYOGHOUL",
                hint: "Menschenfresser in Tokio",
                difficulty: 3
            },
            {
                word: "FAIRYTAIL",
                hint: "Magische Gilde",
                difficulty: 2
            },
            {
                word: "BLACKCLOVER",
                hint: "Magier ohne Magie",
                difficulty: 2
            },
            {
                word: "HUNTERXHUNTER",
                hint: "Jagd nach Abenteuern",
                difficulty: 3
            },
            {
                word: "FULLMETALALCHEMIST",
                hint: "Brüder auf der Suche",
                difficulty: 3
            },
            {
                word: "BLEACH",
                hint: "Seelenretter",
                difficulty: 2
            },
            {
                word: "JOJO",
                hint: "Bizarrer Kampf",
                difficulty: 1
            },
            {
                word: "EVANGELION",
                hint: "Riesenroboter",
                difficulty: 3
            }
        ]
    },
    {
        category: "Charaktere",
        items: [
            {
                word: "GOKU",
                hint: "Saiyajin-Krieger",
                difficulty: 1
            },
            {
                word: "LIGHT",
                hint: "Todesnotizbuch-Besitzer",
                difficulty: 2
            },
            {
                word: "EREN",
                hint: "Titan-Jäger",
                difficulty: 2
            },
            {
                word: "MONKEYDLUFFY",
                hint: "Gummi-Pirat",
                difficulty: 3
            },
            {
                word: "NARUTO",
                hint: "Ninja mit Fuchsdämon",
                difficulty: 1
            },
            {
                word: "TANJIRO",
                hint: "Dämonenjäger",
                difficulty: 2
            },
            {
                word: "DEKU",
                hint: "Superhelden-Schüler",
                difficulty: 2
            },
            {
                word: "KANAKI",
                hint: "Tokio Ghoul",
                difficulty: 3
            },
            {
                word: "EDWARD",
                hint: "Stahl-Alchemist",
                difficulty: 2
            },
            {
                word: "ICHIGO",
                hint: "Seelenretter",
                difficulty: 2
            },
            {
                word: "GON",
                hint: "Jäger",
                difficulty: 1
            },
            {
                word: "SHINJI",
                hint: "Eva-Pilot",
                difficulty: 2
            },
            {
                word: "SAITAMA",
                hint: "Ein-Punch-Man",
                difficulty: 2
            },
            {
                word: "LEVI",
                hint: "Menschenjäger",
                difficulty: 2
            },
            {
                word: "KAKASHI",
                hint: "Kopier-Ninja",
                difficulty: 2
            }
        ]
    },
    {
        category: "Genres",
        items: [
            {
                word: "SHONEN",
                hint: "Jugendliche Helden",
                difficulty: 1
            },
            {
                word: "SEINEN",
                hint: "Erwachsene Zielgruppe",
                difficulty: 2
            },
            {
                word: "SHOUJO",
                hint: "Mädchen-Anime",
                difficulty: 2
            },
            {
                word: "MECHA",
                hint: "Riesenroboter",
                difficulty: 1
            },
            {
                word: "ISEKAI",
                hint: "Andere Welt",
                difficulty: 2
            },
            {
                word: "SLICEOFLIFE",
                hint: "Alltagsgeschichten",
                difficulty: 2
            },
            {
                word: "HORROR",
                hint: "Gruselgeschichten",
                difficulty: 1
            },
            {
                word: "ROMANCE",
                hint: "Liebesgeschichten",
                difficulty: 1
            },
            {
                word: "SPORTS",
                hint: "Sportanime",
                difficulty: 1
            },
            {
                word: "MAGICALGIRL",
                hint: "Magische Mädchen",
                difficulty: 2
            }
        ]
    },
    {
        category: "Studios",
        items: [
            {
                word: "GHIBLI",
                hint: "Miyazaki Studio",
                difficulty: 1
            },
            {
                word: "MAPPA",
                hint: "Attack on Titan Studio",
                difficulty: 2
            },
            {
                word: "BONES",
                hint: "My Hero Academia Studio",
                difficulty: 2
            },
            {
                word: "MADHOUSE",
                hint: "Death Note Studio",
                difficulty: 2
            },
            {
                word: "UFOTABLE",
                hint: "Demon Slayer Studio",
                difficulty: 2
            },
            {
                word: "WIT",
                hint: "Attack on Titan Studio",
                difficulty: 2
            },
            {
                word: "A1PICTURES",
                hint: "Sword Art Online Studio",
                difficulty: 2
            },
            {
                word: "KYOTOANIMATION",
                hint: "Violet Evergarden Studio",
                difficulty: 3
            },
            {
                word: "TRIGGER",
                hint: "Kill la Kill Studio",
                difficulty: 2
            },
            {
                word: "SUNRISE",
                hint: "Gundam Studio",
                difficulty: 2
            }
        ]
    },
    {
        category: "Begriffe",
        items: [
            {
                word: "OTAKU",
                hint: "Anime-Fan",
                difficulty: 1
            },
            {
                word: "MANGA",
                hint: "Japanische Comics",
                difficulty: 1
            },
            {
                word: "ANIME",
                hint: "Japanische Animation",
                difficulty: 1
            },
            {
                word: "COSPLAY",
                hint: "Kostümierung",
                difficulty: 1
            },
            {
                word: "CHIBI",
                hint: "Niedliche Mini-Version",
                difficulty: 1
            },
            {
                word: "KAIJU",
                hint: "Riesenmonster",
                difficulty: 2
            },
            {
                word: "MEKA",
                hint: "Riesenroboter",
                difficulty: 1
            },
            {
                word: "SHONEN",
                hint: "Jugendliche Helden",
                difficulty: 1
            },
            {
                word: "SEINEN",
                hint: "Erwachsene Zielgruppe",
                difficulty: 2
            },
            {
                word: "SHOUJO",
                hint: "Mädchen-Anime",
                difficulty: 2
            }
        ]
    }
];

let currentWordIndex = 0;
let score = 0;
let points = 0;
let currentCategory = 0;
let guessedLetters = new Set();
let remainingLetters = 0;
let gameStarted = false;
let timeLeft = 60; // 60 Sekunden Zeitlimit
let timerInterval;
let allWords = []; // Array für alle Wörter

const startButton = document.getElementById('start-btn');
const nextButton = document.getElementById('next-btn');
const wordDisplay = document.getElementById('word-display');
const hintText = document.getElementById('hint-text');
const lettersCount = document.getElementById('letters-count');
const scoreContainer = document.getElementById('score-container');
const scoreElement = document.getElementById('score');
const totalElement = document.getElementById('total');
const restartButton = document.getElementById('restart-btn');
const keys = document.querySelectorAll('.key');
const pointsElement = document.getElementById('points');
const pointsInfo = document.getElementById('points-info');
const finalPointsElement = document.getElementById('final-points');
const tutorial = document.getElementById('tutorial');
const tutorialClose = document.getElementById('tutorial-close');
const timerElement = document.getElementById('timer');

// Deaktiviere alle Tasten am Anfang
keys.forEach(key => {
    key.disabled = true;
    key.classList.add('disabled');
});

// Tutorial-Event-Listener
tutorialClose.addEventListener('click', () => {
    tutorial.style.display = 'none';
    startButton.disabled = false;
});

startButton.addEventListener('click', startQuiz);
nextButton.addEventListener('click', () => {
    currentWordIndex++;
    setNextWord();
});
restartButton.addEventListener('click', startQuiz);

keys.forEach(key => {
    key.addEventListener('click', () => {
        if (gameStarted) {
            const letter = key.textContent;
            checkLetter(letter);
        }
    });
});

document.addEventListener('keydown', (e) => {
    if (gameStarted) {
        const letter = e.key.toUpperCase();
        if (/^[A-Z]$/.test(letter)) {
            const key = Array.from(keys).find(k => k.textContent === letter);
            if (key && !key.classList.contains('used')) {
                checkLetter(letter);
            }
        }
    }
});

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 10) {
        timerElement.classList.add('warning');
    }
    
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        showScore();
    }
}

function addTime(seconds) {
    timeLeft += seconds;
    // Entferne die Zeitbegrenzung von 60 Sekunden
    updateTimer();
    
    // Zeige Zeit-Bonus/Malus Animation
    const timePopup = document.createElement('div');
    timePopup.className = 'time-popup';
    timePopup.textContent = seconds > 0 ? `+${seconds}s` : `${seconds}s`;
    timePopup.style.color = seconds > 0 ? '#54c754' : '#ff5555';
    document.body.appendChild(timePopup);
    
    // Position in der Mitte des Bildschirms
    timePopup.style.left = '50%';
    timePopup.style.top = '50%';
    timePopup.style.transform = 'translate(-50%, -50%)';
    
    // Entferne nach Animation
    setTimeout(() => {
        timePopup.remove();
    }, 1000);
}

function startTimer() {
    timeLeft = 60;
    updateTimer();
    timerElement.classList.remove('warning');
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

// Funktion zum Erstellen des Wortpools
function createWordPool() {
    allWords = [];
    words.forEach(category => {
        category.items.forEach(item => {
            allWords.push({
                word: item.word,
                hint: item.hint,
                difficulty: item.difficulty,
                category: category.category
            });
        });
    });
    // Mische die Wörter zufällig
    allWords.sort(() => Math.random() - 0.5);
}

function startQuiz() {
    gameStarted = true;
    startButton.classList.add('hide');
    scoreContainer.classList.add('hide');
    currentWordIndex = 0;
    score = 0;
    points = 0;
    
    // Erstelle den Wortpool
    createWordPool();
    
    updateStats();
    
    // Aktiviere alle Tasten
    keys.forEach(key => {
        key.disabled = false;
        key.classList.remove('disabled');
    });
    
    // Initialisiere Timer
    timeLeft = 60;
    updateTimer();
    timerElement.classList.remove('warning');
    
    setNextWord();
}

function setNextWord() {
    resetState();
    const currentWord = allWords[currentWordIndex];
    hintText.textContent = currentWord.hint;
    remainingLetters = currentWord.word.length;
    lettersCount.textContent = remainingLetters;
    updateWordDisplay();
    // Starte Timer für neues Wort
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
    }, 1000);
}

function updateWordDisplay() {
    const currentWord = allWords[currentWordIndex].word;
    const display = currentWord
        .split('')
        .map(letter => guessedLetters.has(letter) ? letter : '_')
        .join(' ');
    wordDisplay.textContent = display;
}

function updateStats() {
    pointsElement.textContent = points;
}

function showPointsPopup(points, x, y) {
    pointsInfo.textContent = points > 0 ? `+${points}` : `${points}`;
    pointsInfo.style.left = `${x}px`;
    pointsInfo.style.top = `${y}px`;
    pointsInfo.classList.add('show');
    pointsInfo.style.color = points > 0 ? 'var(--correct-color)' : 'var(--wrong-color)';
    setTimeout(() => {
        pointsInfo.classList.remove('show');
    }, 1000);
}

function calculatePoints(letter, isCorrect) {
    let pointsGained = 0;
    
    if (isCorrect) {
        const currentWord = allWords[currentWordIndex];
        // Basis-Punkte basierend auf Schwierigkeitsgrad
        pointsGained = 10 * currentWord.difficulty;
        
        // Bonus für seltene Buchstaben
        const rareLetters = ['Q', 'X', 'Y', 'Z'];
        if (rareLetters.includes(letter)) {
            pointsGained *= 2;
        }
        
        // Bonus für schnelles Raten (erste 3 Versuche)
        if (guessedLetters.size < 3) {
            pointsGained *= 1.5;
        }
    } else {
        // Minuspunkte für falsche Buchstaben
        const currentWord = allWords[currentWordIndex];
        // Basis-Minuspunkte basierend auf Schwierigkeitsgrad
        pointsGained = -5 * currentWord.difficulty;
        
        // Zusätzliche Minuspunkte für seltene Buchstaben
        const rareLetters = ['Q', 'X', 'Y', 'Z'];
        if (rareLetters.includes(letter)) {
            pointsGained *= 1.5;
        }
    }
    
    points += Math.round(pointsGained);
    updateStats();
    return Math.round(pointsGained);
}

function checkLetter(letter) {
    const currentWord = allWords[currentWordIndex].word;
    const key = Array.from(keys).find(k => k.textContent === letter);
    
    if (guessedLetters.has(letter)) return;
    
    guessedLetters.add(letter);
    key.classList.add('used');
    
    if (currentWord.includes(letter)) {
        key.classList.add('correct');
        remainingLetters -= (currentWord.match(new RegExp(letter, 'g')) || []).length;
        lettersCount.textContent = remainingLetters;
        
        const pointsGained = calculatePoints(letter, true);
        showPointsPopup(pointsGained, key.offsetLeft, key.offsetTop);
        
        // Zeit-Bonus für richtigen Buchstaben
        addTime(1);
        
        if (remainingLetters === 0) {
            // Bonus für vollständiges Wort
            const wordBonus = Math.round(points * 0.2);
            points += wordBonus;
            updateStats();
            
            score++;
            // Stoppe Timer wenn Wort fertig
            clearInterval(timerInterval);
            if (currentWordIndex < allWords.length - 1) {
                nextButton.classList.remove('hide');
            } else {
                showScore();
            }
        }
    } else {
        key.classList.add('wrong');
        calculatePoints(letter, false);
        // Zeit-Malus für falschen Buchstaben
        addTime(-2);
    }
    
    updateWordDisplay();
}

function resetState() {
    guessedLetters.clear();
    keys.forEach(key => {
        key.classList.remove('used', 'correct', 'wrong');
        if (!gameStarted) {
            key.disabled = true;
            key.classList.add('disabled');
        }
    });
    nextButton.classList.add('hide');
}

function showScore() {
    stopTimer();
    wordDisplay.parentElement.classList.add('hide');
    scoreContainer.classList.remove('hide');
    scoreElement.textContent = score;
    totalElement.textContent = allWords.length;
    finalPointsElement.textContent = points;
    
    // Berechne und zeige die Erfolgsrate
    const successRate = Math.round((score / allWords.length) * 100);
    document.getElementById('success-rate').textContent = successRate;
}
